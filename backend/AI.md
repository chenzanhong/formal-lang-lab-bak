# FormalLangLab AI模块文档

## 1. 概述

AI模块是FormalLangLab项目的智能辅助学习服务，负责为用户提供形式语言和自动机理论相关的智能问答功能。该模块基于大语言模型技术，支持多种通信方式，并针对常见问题实现了缓存优化，为用户提供高效的学习辅助服务。

## 2. 技术栈

- **开发语言**: Go
- **框架**: 微服务架构，独立部署
- **AI模型**: 大语言模型（支持OpenAI、本地模型等）
- **向量数据库**: Qdrant（用于知识检索）(待实现)
- **预置高频QA缓存**: Redis（用于缓存常见问题的回答，降低模型调用延迟）
- **知识管理**: RAG（检索增强生成）架构（待实现）
- **容器化**: Docker
- **部署**: 支持Docker Compose编排

## 3. 项目结构

```
ai/
├── cmd/              # 应用入口
├── configs/          # 配置文件
├── internal/         # 内部实现
│   ├── api/          # API层
│   ├── service/      # 业务逻辑层
│   ├── repository/   # 数据访问层
│   ├── model/        # 数据模型
│   └── pkg/          # 内部工具包
├── pkg/              # 可导出的公共包
├── asset/            # 资源文件（如领域知识文档）
├── docs/             # API文档
├── logs/             # 日志目录
├── migrations/       # 数据库迁移脚本
├── test/             # 测试文件
├── Dockerfile        # Docker构建文件
├── go.mod            # Go模块定义
└── README.md         # 模块说明
```

## 4. 核心功能

### 4.1 文本问答系统

- **实时对话交互**: 提供基于文本的智能问答功能，支持形式语言和自动机理论相关问题
- **多模型支持**: 集成阿里云Qwen API和Ollama本地模型，提供灵活的部署选择
- **上下文感知**: 能够理解和处理自动机、文法、正则表达式等结构化输入的上下文

### 4.2 流式通信支持

- **WebSocket通信**: 默认优先使用的全双工通信方式，提供最佳实时交互体验
- **SSE降级机制**: 当WebSocket不可用时，自动降级为Server-Sent Events通信方式
- **流式响应**: 支持AI生成内容的流式输出，减少用户等待时间

### 4.3 性能优化机制

- **高频问题缓存**: 实现QACache机制，预置和缓存常见问题的回答，提升响应速度
- **消息缓冲处理**: 优化消息处理流程，提高并发能力
- **会话管理**: 支持基于Redis的会话持久化，保存历史对话记录

### 4.4 基础架构特性

- **分层架构设计**: 采用Handler -> Service -> Repository的分层结构
- **错误处理机制**: 提供基础的错误捕获和返回机制
- **容器化支持**: 完全Docker化，支持Docker Compose编排部署

## 5. API接口

### 5.1 WebSocket接口

```
ws://[host]:[port]/gdesign/ai/ws
```

**功能**：建立WebSocket连接进行实时AI对话
**参数**：通过初始消息发送用户问题和上下文
**返回**：流式返回AI生成的回答

### 5.2 SSE接口

```
POST /gdesign/ai/sse
```

**功能**：使用Server-Sent Events进行AI对话
**参数**：
- `message`: 用户输入的问题
- `context`: 当前页面上下文（自动机、文法等信息）

**返回**：流式返回AI生成的回答，格式为SSE事件流

### 5.3 健康检查接口

```
GET /gdesign/ai/health
```

**功能**：检查AI服务是否正常运行

## 6. 部署说明

### 6.1 Docker部署

```bash
docker compose up -d ai
```

## 7. 限制与未来规划

### 7.1 当前限制

- **仅支持文本问答**：暂不支持自动机/文法的错误诊断与修复（操作页面）
- **RAG架构待实现**：向量数据库和知识检索功能尚未集成
- **安全性需加强**：WebSocket连接存在安全隐患

### 7.2 未来功能

- **非文本操作能力**：增加自动机/文法的错误诊断与修复功能（操作页面）
- **RAG增强**：实现基于向量数据库的知识检索增强生成
- **个性化学习**：提供更智能的个性化学习推荐
- **交互式操作**：支持AI直接修改系统状态
