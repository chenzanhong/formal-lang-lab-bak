# FormalLangLab Auth服务概述

## 1. 服务概述

FormalLangLab Auth服务是一个完整的用户认证与授权服务，负责用户注册、登录、密码管理以及身份验证等核心安全功能。该服务采用微服务架构设计，与FormalLangLab项目中的其他服务协同工作，提供统一的用户身份管理能力。

## 2. 技术栈

- **编程语言**：Go
- **Web框架**：Gin
- **数据库**：PostgreSQL (用户数据存储) + Redis (缓存与令牌存储)
- **认证机制**：JWT (JSON Web Token)
- **消息队列**：Kafka (异步邮件发送)
- **监控工具**：Prometheus + pprof
- **日志系统**：zlog
- **密码加密**：bcrypt
- **部署方式**：支持HTTP/HTTPS，可容器化部署

## 3. 项目结构

服务采用清晰的分层架构，主要包括以下部分：

```
backend/auth/
├── cmd/main.go                # 服务入口，负责初始化和启动
├── configs/config.go          # 配置管理
├── internal/
│   ├── api/                   # API层
│   │   ├── router.go          # 路由定义和中间件配置
│   │   ├── user.go            # 用户相关请求处理
│   │   └── email.go           # 邮件相关请求处理
│   ├── service/               # 服务层
│   │   ├── user_s/            # 用户服务
│   │   │   ├── register.go    # 注册逻辑
│   │   │   ├── login.go       # 登录逻辑
│   │   │   ├── refresh.go     # 令牌刷新
│   │   │   └── reset_pwd.go   # 密码重置
│   │   ├── email_s/           # 邮件服务
│   │   │   └── email.go       # 邮件发送逻辑
│   │   └── kafka_s/           # Kafka服务
│   │       └── producer.go    # Kafka生产者实现
│   ├── repository/            # 数据访问层
│   ├── domain/                # 领域模型
│   ├── middleware/            # 中间件
│   ├── metrics/               # 监控指标
│   └── errors/                # 错误定义
└── pkg/                       # 公共工具包
    ├── cryptoutil/            # 密码加密工具
    └── token/                 # 令牌生成工具
```

## 4. 核心功能

### 4.1 用户认证与会话管理
- **用户注册**：验证验证码有效性、检查用户名和邮箱唯一性、密码加密存储、用户创建
- **用户登录**：凭据验证、JWT访问令牌生成、刷新令牌创建与Redis存储、会话管理
- **用户登出**：刷新令牌撤销、会话终止
- **令牌刷新**：支持使用刷新令牌获取新的访问令牌，延长会话有效期

### 4.2 邮件验证系统
- **注册验证码发送**：异步发送注册确认验证码，含频率限制（1分钟内只能发送1次）
- **密码重置验证**：发送密码重置验证码，支持用户身份验证
- **验证码管理**：Redis存储验证码，设置有效期（1分钟），自动过期清理
- **HTML模板支持**：使用美观的HTML邮件模板，包含品牌标识和详细说明

### 4.3 安全机制
- **密码安全**：使用bcrypt进行密码哈希，保障密码存储安全
- **JWT认证**：基于HS256算法的JWT令牌，包含用户信息和过期时间
- **刷新令牌安全**：随机生成的高强度刷新令牌，存储在Redis中
- **请求频率限制**：全局速率限制中间件，防止暴力攻击和请求滥用

### 4.4 系统集成与扩展性
- **Kafka异步处理**：邮件发送采用Kafka异步处理，提高系统响应速度和可靠性
- **数据库集成**：PostgreSQL存储用户数据，Redis提供高速缓存和临时数据存储
- **健康检查**：提供健康检查API，支持服务状态监控
- **优雅关闭**：支持系统信号监听，确保服务优雅关闭，资源正确释放

### 4.5 监控与可观测性
- **Prometheus指标**：集成Prometheus监控，提供HTTP请求计数、延迟等关键指标
- **pprof性能分析**：支持性能分析，便于问题排查和性能优化
- **分布式追踪**：可选的系统调用追踪功能
- **结构化日志**：使用zlog提供结构化日志记录，便于日志分析和问题定位

## 5. API接口

### 5.1 公开接口

#### 健康检查
- **GET /gdesign/auth/health**
  - 描述：检查服务健康状态
  - 响应：`{"status": "ok"}`

#### 用户注册
- **POST /gdesign/auth/register**
  - 描述：用户注册接口
  - 请求体：
    ```json
    {
      "name": "用户名",
      "email": "用户邮箱",
      "password": "密码",
      "token": "注册验证码"
    }
    ```
  - 响应：成功返回用户信息，失败返回错误信息

#### 用户登录
- **POST /gdesign/auth/login**
  - 描述：用户登录接口
  - 请求体：
    ```json
    {
      "name": "用户名",
      "password": "密码"
    }
    ```
  - 响应：
    ```json
    {
      "result": true,
      "msg": "登录成功",
      "access_token": "JWT访问令牌",
      "refresh_token": "刷新令牌",
      "name": "用户名",
      "id": 用户ID
    }
    ```

#### 用户登出
- **POST /gdesign/auth/logout**
  - 描述：用户登出接口
  - 请求体：
    ```json
    {
      "refresh_token": "刷新令牌"
    }
    ```

#### 令牌刷新
- **POST /gdesign/auth/refresh**
  - 描述：刷新访问令牌
  - 请求体：
    ```json
    {
      "refresh_token": "刷新令牌"
    }
    ```

#### 密码重置
- **POST /gdesign/auth/reset-pwd**
  - 描述：重置用户密码
  - 请求体：
    ```json
    {
      "email": "用户邮箱",
      "token": "验证码",
      "password": "新密码"
    }
    ```

### 5.2 验证码接口

#### 发送注册验证码
- **POST /gdesign/auth/register/code**
  - 描述：发送注册验证码到用户邮箱
  - 请求体：
    ```json
    {
      "email": "用户邮箱"
    }
    ```

#### 发送密码重置验证码
- **POST /gdesign/auth/reset-pwd/code**
  - 描述：发送密码重置验证码到用户邮箱
  - 请求体：
    ```json
    {
      "email": "用户邮箱"
    }
    ```

### 5.3 需要认证的接口

#### 用户信息验证
- **GET /gdesign/auth/me**
  - 描述：验证当前用户身份并返回用户信息
  - 头部：需要携带有效的JWT访问令牌

## 6. 主要流程

### 6.1 用户注册流程
1. 用户请求发送注册验证码到邮箱
2. 系统检查邮箱是否已注册，生成验证码并存储到Redis
3. 异步发送HTML格式的验证码邮件
4. 用户填写注册信息并提交验证码
5. 系统验证验证码有效性，检查用户名和邮箱唯一性
6. 加密密码并创建用户记录
7. 注册成功后清除验证码

### 6.2 用户登录流程
1. 用户提交用户名和密码
2. 系统验证用户名和密码
3. 生成JWT访问令牌和随机刷新令牌
4. 将刷新令牌存储到Redis中
5. 返回访问令牌和刷新令牌给用户

### 6.3 用户登出流程
1. 用户发起登出请求并提供刷新令牌
2. 系统接收请求并验证刷新令牌
3. 从Redis中删除对应的刷新令牌，使其失效
4. 返回登出成功响应
5. 客户端清除本地存储的访问令牌和用户信息

### 6.4 令牌刷新流程
1. 用户提供刷新令牌请求新的访问令牌
2. 系统验证刷新令牌的有效性
3. 根据刷新令牌获取用户信息
4. 生成新的访问令牌和新的刷新令牌
5. 删除旧的刷新令牌，保存新的刷新令牌到Redis
6. 返回新的访问令牌和新的刷新令牌给用户

## 7. 限制与注意事项

- 验证码有效期为1分钟
- 同一邮箱每分钟最多发送1次验证码
- JWT访问令牌有固定的过期时间
- 刷新令牌存储在Redis中，可随时撤销
- 系统采用严格的错误处理和日志记录机制
- 在生产环境中必须配置安全的JWT密钥
- 密码加密使用bcrypt算法，确保安全性
- 支持HTTPS加密传输，保障数据安全

## 9. 性能与安全特性

- **性能优化**：Redis缓存、异步处理、连接池管理
- **安全加固**：密码加密、JWT验证、请求频率限制、HTTPS支持
- **可观测性**：Prometheus监控、结构化日志、性能分析工具集成
- **容错处理**：错误标准化、异常捕获、资源清理保证


