# FormalLangLab 邮件服务模块文档

## 1. 概述

邮件服务模块是FormalLangLab项目的通信基础设施，作为一个独立的Kafka消费者服务，负责处理用户注册确认、密码重置、系统通知等各类邮件发送功能。该模块采用微服务架构设计，通过Kafka消息队列实现异步处理，提供高可靠、可扩展的邮件发送能力。

## 2. 技术栈

- **开发语言**: Go 1.24+
- **消息队列**: Kafka
- **邮件客户端**: gomail v2
- **监控**: Prometheus
- **日志**: zlog
- **配置管理**: 环境变量 + YAML配置文件
- **容器化**: Docker
- **部署**: Docker Compose

## 3. 项目结构

```
email/
├── configs/          # 配置文件目录
│   ├── config.yaml   # 主要配置文件
├── logs/             # 日志目录
├── metrics/          # 监控指标模块
├── model/            # 数据模型（包含Kafka事件结构）
├── main.go           # 应用入口（Kafka消费者）
├── Dockerfile        # Docker构建文件
├── go.mod            # Go模块定义
├── go.sum            # 依赖版本锁定
└── .gitignore        # Git忽略文件
```

## 4. 核心功能

### 4.1 Kafka消息消费

- **异步消费**: 从Kafka主题异步读取邮件发送请求
- **消息解析**: 将JSON格式的邮件事件解析为内部模型
- **消费者组**: 使用消费者组模式实现高可用性

### 4.2 邮件发送服务

- **SMTP支持**: 通过SMTP协议发送邮件
- **内容类型支持**: 支持HTML和文本格式邮件
- **TLS加密**: 支持邮件传输加密
- **错误处理**: 详细的错误类型识别（认证失败、连接失败等）

### 4.3 重试机制

- **自动重试**: 邮件发送失败时自动重试
- **指数退避**: 采用指数退避算法进行重试间隔设置
- **最大重试次数**: 可配置的最大重试次数（默认3次）

### 4.4 监控与可观测性

- **Prometheus指标**: 记录邮件发送成功/失败次数和耗时
- **健康检查**: 提供HTTP健康检查端点
- **日志记录**: 结构化日志记录，包含详细的操作信息
- **性能分析**: 支持pprof和trace调试工具

### 4.5 配置管理

- **环境变量配置**: 支持通过环境变量配置关键参数
  - `EMAIL_NAME`: 发件人邮箱
  - `EMAIL_PASSWORD`: 邮箱授权码
  - `SMTP_SERVER_HOST`: SMTP服务器地址
  - `SMTP_SERVER_PORT`: SMTP服务器端口
  - `SERVER_PORT`: 健康检查服务端口
  - `METRICS_PORT`: Prometheus指标服务端口
  - `ENABLE_TRACE`: 是否启用性能追踪
  - `PPROF_PORT`: pprof调试端口

- **YAML配置文件**: 支持通过配置文件设置Kafka、日志等参数

### 4.6 优雅关闭

- **信号处理**: 响应SIGINT和SIGTERM信号
- **资源清理**: 优雅关闭Kafka连接和其他资源

## 5. API接口

### 5.1 健康检查接口

```
GET /gdesign/master/health
```

**功能**: 提供服务健康状态检查
**返回**: `{"status":"ok"}`

### 5.2 指标接口

```
GET /gdesign/email/metrics
```

**功能**: 提供Prometheus格式的监控指标

## 6. 部署说明

### 6.1 Docker部署

```bash
docker compose up -d email
```

### 6.2 配置依赖

- **Kafka服务**: 需确保Kafka集群正常运行
- **环境变量**: 需设置有效的邮箱配置信息
- **端口映射**: 根据需要映射健康检查和指标服务端口

## 7. 主要流程

1. 服务启动时加载配置并初始化日志和指标
2. 连接Kafka并订阅指定主题
3. 启动健康检查和指标服务
4. 持续从Kafka读取邮件事件
5. 对每个事件调用邮件发送逻辑，并记录指标
6. 遇到发送失败时执行重试策略
7. 收到关闭信号时优雅退出

## 8. 限制与注意事项

- 目前仅支持SMTP协议的邮件发送
- 邮件发送失败后不会发送到死信队列（DLQ），需要前端用户手动重试（前端限制一分钟请求一次）
- 生产环境中应禁用TLS证书验证跳过选项
- 邮件内容需要由调用方预先格式化（支持HTML和纯文本）

## 9. 未来规划